<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KFON Customer Interest</title>
<style>
  body { font-family: Arial, sans-serif; padding: 12px; max-width: 980px; margin: auto; }
  h1{font-size:1.2rem}
  label{display:block;margin-top:10px;font-weight:600}
  input, select, textarea, button { width:100%; padding:10px; margin-top:6px; box-sizing:border-box; }
  button{margin-top:14px;padding:12px 16px;font-weight:700}
  .row { display:flex; gap:8px; flex-wrap:wrap; }
  .col2 { flex:1; min-width:150px; }
  .muted { font-weight:400; font-size:0.9rem; color:#555; margin-top:6px; }
  .inline { display:flex; gap:8px; }
  .inline > * { flex:1; }
  @media (max-width:520px) {
    .inline { flex-direction:column; }
    input, select, textarea, button { font-size:16px; }
  }
  #lnpName { height: 220px; overflow:auto; }
  .success{background:#e6ffed;border-left:4px solid #2aa44f;padding:10px;margin-top:12px}
  .error{background:#ffe6e6;border-left:4px solid #d33;padding:10px;margin-top:12px}
  .info{background:#eef6ff;border-left:4px solid #2b7cff;padding:10px;margin-top:12px}
</style>
</head>
<body>
  <h1>KFON — Customer Interest Form</h1>

  <!-- hidden iframe fallback -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

  <form id="interestForm" method="post"
    action="https://script.google.com/macros/s/AKfycbxhOKkaGaLJfjVU72gX1Px7VWoC0D1Ub5AI1IMWXkZTQzkTa92DaR0UkbQ4JE3NqRfj/exec"
    target="hidden_iframe">

    <label>Customer Name<input type="text" name="customerName" required></label>
    <label>Address<textarea name="address" rows="2" required></textarea></label>

    <div class="row">
      <div class="col2"><label>Pincode<input name="pincode" required></label></div>
      <div class="col2"><label>State
        <select name="state" id="state" required></select>
      </label></div>
    </div>

    <div class="row">
      <div class="col2"><label>District
        <select name="district" id="district" required></select>
      </label></div>
      <div class="col2"><label>Email ID<input type="email" name="email"></label></div>
    </div>

    <label>Phone Number<input name="phone" required pattern="[0-9]{7,15}" title="numbers only"></label>

    <label>Already using another ISP?
      <select name="alreadyUsingIsp" id="alreadyUsingIsp">
        <option value="No">No</option>
        <option value="Yes">Yes</option>
      </select>
    </label>

    <label>If yes which ISP<input name="whichIsp" placeholder="e.g. Airtel / Jio / Local ISP"></label>

    <!-- Search + Partner ID + LNP (display partner : company) + FE -->
    <div class="row">
      <div class="col2">
        <label>Search LNP / Company or Partner ID
          <input type="search" id="lnpSearch" placeholder="Type company or partner id to filter">
        </label>
      </div>

      <div class="col2">
        <label>Partner ID (auto-filled when selecting company)
          <input name="partnerId" id="partnerId" placeholder="e.g. 5001036760">
        </label>
      </div>
    </div>

    <div class="row inline">
      <div class="col2">
        <label>LNP (PartnerID : Company) — tap to select
          <select name="lnpName" id="lnpName" size="8"></select>
        </label>
        <div class="muted">Tip: search above then tap company. The list shows "PartnerID : Company Name".</div>
      </div>

      <div class="col2">
        <label>FE Name (auto-filled)
          <input name="feName" id="feName" readonly placeholder="FE will appear here">
        </label>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button type="button" id="findByPartner" style="flex:1">Find by Partner ID</button>
          <button type="button" id="clearFilter" style="flex:1">Clear</button>
        </div>
      </div>
    </div>

    <label>Plan Needed<input name="planNeeded" placeholder="e.g. 100 Mbps / 200 GB"></label>

    <div class="row">
      <div class="col2"><label>Connection Needed Date<input type="date" name="connectionDate"></label></div>
      <div class="col2"><label>Feasible or Not
        <select name="feasible">
          <option>Feasible</option>
          <option>Not Feasible</option>
          <option>Pending Field Visit</option>
        </select>
      </label></div>
    </div>

    <label>Notes (optional)<textarea name="notes" rows="2"></textarea></label>

    <button type="submit">Submit</button>
  </form>

  <div id="msg"></div>

<script>
/* ---------- config ---------- */
const POST_URL = 'https://script.google.com/macros/s/AKfycbxhOKkaGaLJfjVU72gX1Px7VWoC0D1Ub5AI1IMWXkZTQzkTa92DaR0UkbQ4JE3NqRfj/exec';
/* --------------------------- */

/* states + districts (Kerala full, add more as needed) */
const states = [
  "Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa",
  "Gujarat","Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala",
  "Madhya Pradesh","Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland",
  "Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura",
  "Uttar Pradesh","Uttarakhand","West Bengal","Andaman and Nicobar Islands",
  "Chandigarh","Dadra and Nagar Haveli and Daman and Diu","Delhi","Jammu and Kashmir",
  "Ladakh","Lakshadweep","Puducherry"
];
const districts = {
  "Kerala": [
    "Thiruvananthapuram","Kollam","Pathanamthitta","Alappuzha","Kottayam",
    "Idukki","Ernakulam","Thrissur","Palakkad","Malappuram","Kozhikode",
    "Wayanad","Kannur","Kasaragod"
  ]
};

/* LNP entries (partner : company) -> fe name
   (You already provided many. Keep/edit here as needed.)
*/
const lnpEntries = [
  { partner: "5001036760", company: "METRO CABLE VISION", fe: "RAJATH KRISHNA" },
  { partner: "2604810007", company: "RIZA ELECTRONICS AND CABLES TV", fe: "" },
  { partner: "2169274433", company: "METRO DIGITAL VISION", fe: "RAJATH KRISHNA" },
  { partner: "7417013662", company: "VEGA VISION", fe: "ABHIJITH VR" },
  { partner: "7419746167", company: "CHANNEL TRACK CABLE NETWORK", fe: "ABHIJITH VR" },
  { partner: "2522821809", company: "NEWSTAR CABLE TV NETWORK", fe: "ASWIN MOHAN" },
  { partner: "7019695404", company: "JEEVAN CABLE NETWORK", fe: "" },
  { partner: "1777735887", company: "NEW CABLE VISION", fe: "ABHIJITH VR" },
  { partner: "3934588600", company: "MEDIA VISION DIGITAL NETWORK", fe: "ABHIJITH VR" },
  { partner: "5842983774", company: "SPACE CABLE NETWORK", fe: "ASWIN MOHAN" },
  /* ... add rest of the list here (I included many previously). Continue adding objects for all companies ... */
  { partner: "2443320165", company: "CHAITHANYA CABLE NETWORK", fe: "" },
  { partner: "2624853239", company: "B4U CABLE NETWORK", fe: "" }
];

/* ---------- build UI ---------- */
const stateSelect = document.getElementById('state');
const districtSelect = document.getElementById('district');
const lnpSelect = document.getElementById('lnpName');
const lnpSearch = document.getElementById('lnpSearch');
const partnerInput = document.getElementById('partnerId');
const feInput = document.getElementById('feName');

function populateStates(){
  stateSelect.innerHTML = '<option value="">Select State</option>';
  states.forEach(s => stateSelect.innerHTML += `<option value="${s}">${s}</option>`);
}
populateStates();

stateSelect.addEventListener('change', () => {
  const s = stateSelect.value;
  districtSelect.innerHTML = '';
  if (!s) return districtSelect.innerHTML = '<option value="">Select district</option>';
  if (districts[s]) {
    districtSelect.innerHTML = '<option value="">Select district</option>';
    districts[s].forEach(d => districtSelect.innerHTML += `<option value="${d}">${d}</option>`);
  } else {
    districtSelect.innerHTML = '<option value="">No districts available</option>';
  }
});

/* Build LNP options (shows "partner : company") */
function buildLnp(filter = '') {
  lnpSelect.innerHTML = '';
  const f = (filter || '').toString().trim().toLowerCase();
  const matched = lnpEntries.filter(e => {
    return !f || e.company.toLowerCase().includes(f) || e.partner.includes(f);
  });
  if (matched.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No companies found';
    lnpSelect.appendChild(opt);
    return;
  }
  matched.forEach(e => {
    const opt = document.createElement('option');
    opt.value = `${e.partner} : ${e.company}`; // value as "partner : company"
    opt.textContent = `${e.partner} : ${e.company}`;
    opt.dataset.partner = e.partner;
    opt.dataset.company = e.company;
    opt.dataset.fe = e.fe || '';
    lnpSelect.appendChild(opt);
  });
}
buildLnp();

/* search filter */
lnpSearch.addEventListener('input', () => {
  buildLnp(lnpSearch.value);
  partnerInput.value = '';
  feInput.value = '';
});

/* when user selects from list, set partner, FE, company */
lnpSelect.addEventListener('change', () => {
  const opt = lnpSelect.options[lnpSelect.selectedIndex];
  if (!opt) return;
  partnerInput.value = opt.dataset.partner || '';
  feInput.value = opt.dataset.fe || '';
  // also set the lnpName value to company only (Apps Script gets lnpName param)
  // HTML select's value is "partner : company" – it's okay, we'll parse in Apps Script.
});

/* find by partner button */
document.getElementById('findByPartner').addEventListener('click', () => {
  const pid = partnerInput.value.trim();
  if (!pid) return alert('Paste or type Partner ID into the Partner ID box first.');
  // find exact match
  const idx = lnpEntries.findIndex(e => e.partner === pid);
  if (idx >= 0) {
    buildLnp(''); // refresh list
    // find option index
    for (let i=0;i<lnpSelect.options.length;i++){
      if (lnpSelect.options[i].dataset.partner === pid){
        lnpSelect.selectedIndex = i;
        lnpSelect.dispatchEvent(new Event('change'));
        lnpSelect.scrollTo(0, lnpSelect.options[i].offsetTop);
        return;
      }
    }
  }
  // fallback: filter list by pid text
  buildLnp(pid);
  if (lnpSelect.options.length > 0 && lnpSelect.options[0].value) {
    lnpSelect.selectedIndex = 0;
    lnpSelect.dispatchEvent(new Event('change'));
  } else {
    alert('No matching company found for Partner ID: ' + pid);
  }
});

/* clear filter */
document.getElementById('clearFilter').addEventListener('click', () => {
  lnpSearch.value = '';
  partnerInput.value = '';
  feInput.value = '';
  buildLnp('');
});

/* ---------- form submit (JSON fetch with iframe fallback) ---------- */
const form = document.getElementById('interestForm');
const msg = document.getElementById('msg');

form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  msg.innerHTML = '<div class="info">Submitting…</div>';

  // collect form data
  const data = Object.fromEntries(new FormData(form).entries());

  // if LNP selected as "partner : company", ensure we split for clarity
  if (data.lnpName && data.lnpName.includes(':')) {
    const parts = data.lnpName.split(':');
    data.partnerId = (parts[0] || '').trim();
    data.lnpName = (parts.slice(1).join(':') || '').trim();
  } else {
    // if user typed partnerId but didn't select, keep partnerId field
    data.partnerId = data.partnerId || '';
  }

  // ensure feName present (from selection)
  data.feName = data.feName || '';

  // sanitize phone
  data.phone = data.phone ? data.phone.replace(/\s+/g,'') : '';

  try {
    const res = await fetch(POST_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const j = await res.json();
    if (j && j.status === 'success') {
      msg.innerHTML = '<div class="success">Saved ✓ — Next record ready.</div>';
      form.reset();
      buildLnp('');
      return;
    } else {
      fallbackSubmit('Server returned error — using fallback submit.');
    }
  } catch (err) {
    fallbackSubmit('Network/CORS — using fallback submit.');
  }
});

function fallbackSubmit(note = '') {
  try {
    form.submit();
    msg.innerHTML = `<div class="success">Submitted (via form). ${note}</div>`;
    form.reset();
    buildLnp('');
  } catch (e) {
    msg.innerHTML = '<div class="error">Unable to submit: ' + e.toString() + '</div>';
  }
}
</script>
</body>
</html>
